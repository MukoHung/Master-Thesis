# Get-WinEvent -LogName Microsoft-Windows-Sysmon/Operational | where {($_.ID -eq "11" -and ($_.message -match "TargetFilename.*.*\Invoke-DllInjection.ps1" -or $_.message -match "TargetFilename.*.*\Invoke-WmiCommand.ps1" -or $_.message -match "TargetFilename.*.*\Get-GPPPassword.ps1" -or $_.message -match "TargetFilename.*.*\Get-Keystrokes.ps1" -or $_.message -match "TargetFilename.*.*\Get-VaultCredential.ps1" -or $_.message -match "TargetFilename.*.*\Invoke-CredentialInjection.ps1" -or $_.message -match "TargetFilename.*.*\Invoke-Mimikatz.ps1" -or $_.message -match "TargetFilename.*.*\Invoke-NinjaCopy.ps1" -or $_.message -match "TargetFilename.*.*\Invoke-TokenManipulation.ps1" -or $_.message -match "TargetFilename.*.*\Out-Minidump.ps1" -or $_.message -match "TargetFilename.*.*\VolumeShadowCopyTools.ps1" -or $_.message -match "TargetFilename.*.*\Invoke-ReflectivePEInjection.ps1" -or $_.message -match "TargetFilename.*.*\Get-TimedScreenshot.ps1" -or $_.message -match "TargetFilename.*.*\Invoke-UserHunter.ps1" -or $_.message -match "TargetFilename.*.*\Find-GPOLocation.ps1" -or $_.message -match "TargetFilename.*.*\Invoke-ACLScanner.ps1" -or $_.message -match "TargetFilename.*.*\Invoke-DowngradeAccount.ps1" -or $_.message -match "TargetFilename.*.*\Get-ServiceUnquoted.ps1" -or $_.message -match "TargetFilename.*.*\Get-ServiceFilePermission.ps1" -or $_.message -match "TargetFilename.*.*\Get-ServicePermission.ps1" -or $_.message -match "TargetFilename.*.*\Invoke-ServiceAbuse.ps1" -or $_.message -match "TargetFilename.*.*\Install-ServiceBinary.ps1" -or $_.message -match "TargetFilename.*.*\Get-RegAutoLogon.ps1" -or $_.message -match "TargetFilename.*.*\Get-VulnAutoRun.ps1" -or $_.message -match "TargetFilename.*.*\Get-VulnSchTask.ps1" -or $_.message -match "TargetFilename.*.*\Get-UnattendedInstallFile.ps1" -or $_.message -match "TargetFilename.*.*\Get-WebConfig.ps1" -or $_.message -match "TargetFilename.*.*\Get-ApplicationHost.ps1" -or $_.message -match "TargetFilename.*.*\Get-RegAlwaysInstallElevated.ps1" -or $_.message -match "TargetFilename.*.*\Get-Unconstrained.ps1" -or $_.message -match "TargetFilename.*.*\Add-RegBackdoor.ps1" -or $_.message -match "TargetFilename.*.*\Add-ScrnSaveBackdoor.ps1" -or $_.message -match "TargetFilename.*.*\Gupt-Backdoor.ps1" -or $_.message -match "TargetFilename.*.*\Invoke-ADSBackdoor.ps1" -or $_.message -match "TargetFilename.*.*\Enabled-DuplicateToken.ps1" -or $_.message -match "TargetFilename.*.*\Invoke-PsUaCme.ps1" -or $_.message -match "TargetFilename.*.*\Remove-Update.ps1" -or $_.message -match "TargetFilename.*.*\Check-VM.ps1" -or $_.message -match "TargetFilename.*.*\Get-LSASecret.ps1" -or $_.message -match "TargetFilename.*.*\Get-PassHashes.ps1" -or $_.message -match "TargetFilename.*.*\Show-TargetScreen.ps1" -or $_.message -match "TargetFilename.*.*\Port-Scan.ps1" -or $_.message -match "TargetFilename.*.*\Invoke-PoshRatHttp.ps1" -or $_.message -match "TargetFilename.*.*\Invoke-PowerShellTCP.ps1" -or $_.message -match "TargetFilename.*.*\Invoke-PowerShellWMI.ps1" -or $_.message -match "TargetFilename.*.*\Add-Exfiltration.ps1" -or $_.message -match "TargetFilename.*.*\Add-Persistence.ps1" -or $_.message -match "TargetFilename.*.*\Do-Exfiltration.ps1" -or $_.message -match "TargetFilename.*.*\Start-CaptureServer.ps1" -or $_.message -match "TargetFilename.*.*\Invoke-ShellCode.ps1" -or $_.message -match "TargetFilename.*.*\Get-ChromeDump.ps1" -or $_.message -match "TargetFilename.*.*\Get-ClipboardContents.ps1" -or $_.message -match "TargetFilename.*.*\Get-FoxDump.ps1" -or $_.message -match "TargetFilename.*.*\Get-IndexedItem.ps1" -or $_.message -match "TargetFilename.*.*\Get-Screenshot.ps1" -or $_.message -match "TargetFilename.*.*\Invoke-Inveigh.ps1" -or $_.message -match "TargetFilename.*.*\Invoke-NetRipper.ps1" -or $_.message -match "TargetFilename.*.*\Invoke-EgressCheck.ps1" -or $_.message -match "TargetFilename.*.*\Invoke-PostExfil.ps1" -or $_.message -match "TargetFilename.*.*\Invoke-PSInject.ps1" -or $_.message -match "TargetFilename.*.*\Invoke-RunAs.ps1" -or $_.message -match "TargetFilename.*.*\MailRaider.ps1" -or $_.message -match "TargetFilename.*.*\New-HoneyHash.ps1" -or $_.message -match "TargetFilename.*.*\Set-MacAttribute.ps1" -or $_.message -match "TargetFilename.*.*\Invoke-DCSync.ps1" -or $_.message -match "TargetFilename.*.*\Invoke-PowerDump.ps1" -or $_.message -match "TargetFilename.*.*\Exploit-Jboss.ps1" -or $_.message -match "TargetFilename.*.*\Invoke-ThunderStruck.ps1" -or $_.message -match "TargetFilename.*.*\Invoke-VoiceTroll.ps1" -or $_.message -match "TargetFilename.*.*\Set-Wallpaper.ps1" -or $_.message -match "TargetFilename.*.*\Invoke-InveighRelay.ps1" -or $_.message -match "TargetFilename.*.*\Invoke-PsExec.ps1" -or $_.message -match "TargetFilename.*.*\Invoke-SSHCommand.ps1" -or $_.message -match "TargetFilename.*.*\Get-SecurityPackages.ps1" -or $_.message -match "TargetFilename.*.*\Install-SSP.ps1" -or $_.message -match "TargetFilename.*.*\Invoke-BackdoorLNK.ps1" -or $_.message -match "TargetFilename.*.*\PowerBreach.ps1" -or $_.message -match "TargetFilename.*.*\Get-SiteListPassword.ps1" -or $_.message -match "TargetFilename.*.*\Get-System.ps1" -or $_.message -match "TargetFilename.*.*\Invoke-BypassUAC.ps1" -or $_.message -match "TargetFilename.*.*\Invoke-Tater.ps1" -or $_.message -match "TargetFilename.*.*\Invoke-WScriptBypassUAC.ps1" -or $_.message -match "TargetFilename.*.*\PowerUp.ps1" -or $_.message -match "TargetFilename.*.*\PowerView.ps1" -or $_.message -match "TargetFilename.*.*\Get-RickAstley.ps1" -or $_.message -match "TargetFilename.*.*\Find-Fruit.ps1" -or $_.message -match "TargetFilename.*.*\HTTP-Login.ps1" -or $_.message -match "TargetFilename.*.*\Find-TrustedDocuments.ps1" -or $_.message -match "TargetFilename.*.*\Invoke-Paranoia.ps1" -or $_.message -match "TargetFilename.*.*\Invoke-WinEnum.ps1" -or $_.message -match "TargetFilename.*.*\Invoke-ARPScan.ps1" -or $_.message -match "TargetFilename.*.*\Invoke-PortScan.ps1" -or $_.message -match "TargetFilename.*.*\Invoke-ReverseDNSLookup.ps1" -or $_.message -match "TargetFilename.*.*\Invoke-SMBScanner.ps1" -or $_.message -match "TargetFilename.*.*\Invoke-Mimikittenz.ps1")) } | select TimeCreated,Id,RecordId,ProcessId,MachineName,Message

function Add-Rule {

    $ruleName = "sysmon_powershell_exploit_scripts";
    $detectRule = {
        
        function Search-DetectableEvents {
            param (
                $event
            )
            
            $ruleName = "sysmon_powershell_exploit_scripts";
            $detectedMessage = "Detects the creation of known powershell scripts for exploitation";
            $result = $event |  where { ($_.ID -eq "11" -and ($_.message -match "TargetFilename.*.*\\Invoke-DllInjection.ps1" -or $_.message -match "TargetFilename.*.*\\Invoke-WmiCommand.ps1" -or $_.message -match "TargetFilename.*.*\\Get-GPPPassword.ps1" -or $_.message -match "TargetFilename.*.*\\Get-Keystrokes.ps1" -or $_.message -match "TargetFilename.*.*\\Get-VaultCredential.ps1" -or $_.message -match "TargetFilename.*.*\\Invoke-CredentialInjection.ps1" -or $_.message -match "TargetFilename.*.*\\Invoke-Mimikatz.ps1" -or $_.message -match "TargetFilename.*.*\\Invoke-NinjaCopy.ps1" -or $_.message -match "TargetFilename.*.*\\Invoke-TokenManipulation.ps1" -or $_.message -match "TargetFilename.*.*\\Out-Minidump.ps1" -or $_.message -match "TargetFilename.*.*\\VolumeShadowCopyTools.ps1" -or $_.message -match "TargetFilename.*.*\\Invoke-ReflectivePEInjection.ps1" -or $_.message -match "TargetFilename.*.*\\Get-TimedScreenshot.ps1" -or $_.message -match "TargetFilename.*.*\\Invoke-UserHunter.ps1" -or $_.message -match "TargetFilename.*.*\\Find-GPOLocation.ps1" -or $_.message -match "TargetFilename.*.*\\Invoke-ACLScanner.ps1" -or $_.message -match "TargetFilename.*.*\\Invoke-DowngradeAccount.ps1" -or $_.message -match "TargetFilename.*.*\\Get-ServiceUnquoted.ps1" -or $_.message -match "TargetFilename.*.*\\Get-ServiceFilePermission.ps1" -or $_.message -match "TargetFilename.*.*\\Get-ServicePermission.ps1" -or $_.message -match "TargetFilename.*.*\\Invoke-ServiceAbuse.ps1" -or $_.message -match "TargetFilename.*.*\\Install-ServiceBinary.ps1" -or $_.message -match "TargetFilename.*.*\\Get-RegAutoLogon.ps1" -or $_.message -match "TargetFilename.*.*\\Get-VulnAutoRun.ps1" -or $_.message -match "TargetFilename.*.*\\Get-VulnSchTask.ps1" -or $_.message -match "TargetFilename.*.*\\Get-UnattendedInstallFile.ps1" -or $_.message -match "TargetFilename.*.*\\Get-WebConfig.ps1" -or $_.message -match "TargetFilename.*.*\\Get-ApplicationHost.ps1" -or $_.message -match "TargetFilename.*.*\\Get-RegAlwaysInstallElevated.ps1" -or $_.message -match "TargetFilename.*.*\\Get-Unconstrained.ps1" -or $_.message -match "TargetFilename.*.*\\Add-RegBackdoor.ps1" -or $_.message -match "TargetFilename.*.*\\Add-ScrnSaveBackdoor.ps1" -or $_.message -match "TargetFilename.*.*\\Gupt-Backdoor.ps1" -or $_.message -match "TargetFilename.*.*\\Invoke-ADSBackdoor.ps1" -or $_.message -match "TargetFilename.*.*\\Enabled-DuplicateToken.ps1" -or $_.message -match "TargetFilename.*.*\\Invoke-PsUaCme.ps1" -or $_.message -match "TargetFilename.*.*\\Remove-Update.ps1" -or $_.message -match "TargetFilename.*.*\\Check-VM.ps1" -or $_.message -match "TargetFilename.*.*\\Get-LSASecret.ps1" -or $_.message -match "TargetFilename.*.*\\Get-PassHashes.ps1" -or $_.message -match "TargetFilename.*.*\\Show-TargetScreen.ps1" -or $_.message -match "TargetFilename.*.*\\Port-Scan.ps1" -or $_.message -match "TargetFilename.*.*\\Invoke-PoshRatHttp.ps1" -or $_.message -match "TargetFilename.*.*\\Invoke-PowerShellTCP.ps1" -or $_.message -match "TargetFilename.*.*\\Invoke-PowerShellWMI.ps1" -or $_.message -match "TargetFilename.*.*\\Add-Exfiltration.ps1" -or $_.message -match "TargetFilename.*.*\\Add-Persistence.ps1" -or $_.message -match "TargetFilename.*.*\\Do-Exfiltration.ps1" -or $_.message -match "TargetFilename.*.*\\Start-CaptureServer.ps1" -or $_.message -match "TargetFilename.*.*\\Invoke-ShellCode.ps1" -or $_.message -match "TargetFilename.*.*\\Get-ChromeDump.ps1" -or $_.message -match "TargetFilename.*.*\\Get-ClipboardContents.ps1" -or $_.message -match "TargetFilename.*.*\\Get-FoxDump.ps1" -or $_.message -match "TargetFilename.*.*\\Get-IndexedItem.ps1" -or $_.message -match "TargetFilename.*.*\\Get-Screenshot.ps1" -or $_.message -match "TargetFilename.*.*\\Invoke-Inveigh.ps1" -or $_.message -match "TargetFilename.*.*\\Invoke-NetRipper.ps1" -or $_.message -match "TargetFilename.*.*\\Invoke-EgressCheck.ps1" -or $_.message -match "TargetFilename.*.*\\Invoke-PostExfil.ps1" -or $_.message -match "TargetFilename.*.*\\Invoke-PSInject.ps1" -or $_.message -match "TargetFilename.*.*\\Invoke-RunAs.ps1" -or $_.message -match "TargetFilename.*.*\\MailRaider.ps1" -or $_.message -match "TargetFilename.*.*\\New-HoneyHash.ps1" -or $_.message -match "TargetFilename.*.*\\Set-MacAttribute.ps1" -or $_.message -match "TargetFilename.*.*\\Invoke-DCSync.ps1" -or $_.message -match "TargetFilename.*.*\\Invoke-PowerDump.ps1" -or $_.message -match "TargetFilename.*.*\\Exploit-Jboss.ps1" -or $_.message -match "TargetFilename.*.*\\Invoke-ThunderStruck.ps1" -or $_.message -match "TargetFilename.*.*\\Invoke-VoiceTroll.ps1" -or $_.message -match "TargetFilename.*.*\\Set-Wallpaper.ps1" -or $_.message -match "TargetFilename.*.*\\Invoke-InveighRelay.ps1" -or $_.message -match "TargetFilename.*.*\\Invoke-PsExec.ps1" -or $_.message -match "TargetFilename.*.*\\Invoke-SSHCommand.ps1" -or $_.message -match "TargetFilename.*.*\\Get-SecurityPackages.ps1" -or $_.message -match "TargetFilename.*.*\\Install-SSP.ps1" -or $_.message -match "TargetFilename.*.*\\Invoke-BackdoorLNK.ps1" -or $_.message -match "TargetFilename.*.*\\PowerBreach.ps1" -or $_.message -match "TargetFilename.*.*\\Get-SiteListPassword.ps1" -or $_.message -match "TargetFilename.*.*\\Get-System.ps1" -or $_.message -match "TargetFilename.*.*\\Invoke-BypassUAC.ps1" -or $_.message -match "TargetFilename.*.*\\Invoke-Tater.ps1" -or $_.message -match "TargetFilename.*.*\\Invoke-WScriptBypassUAC.ps1" -or $_.message -match "TargetFilename.*.*\\PowerUp.ps1" -or $_.message -match "TargetFilename.*.*\\PowerView.ps1" -or $_.message -match "TargetFilename.*.*\\Get-RickAstley.ps1" -or $_.message -match "TargetFilename.*.*\\Find-Fruit.ps1" -or $_.message -match "TargetFilename.*.*\\HTTP-Login.ps1" -or $_.message -match "TargetFilename.*.*\\Find-TrustedDocuments.ps1" -or $_.message -match "TargetFilename.*.*\\Invoke-Paranoia.ps1" -or $_.message -match "TargetFilename.*.*\\Invoke-WinEnum.ps1" -or $_.message -match "TargetFilename.*.*\\Invoke-ARPScan.ps1" -or $_.message -match "TargetFilename.*.*\\Invoke-PortScan.ps1" -or $_.message -match "TargetFilename.*.*\\Invoke-ReverseDNSLookup.ps1" -or $_.message -match "TargetFilename.*.*\\Invoke-SMBScanner.ps1" -or $_.message -match "TargetFilename.*.*\\Invoke-Mimikittenz.ps1")) } | select TimeCreated, Id, RecordId, ProcessId, MachineName, Message;
            if ($result -and $result.Count -ne 0) {
                Write-Output ""; 
                Write-Output "Detected! RuleName:$ruleName";
                Write-Output $detectedMessage;
                Write-Output $result;
                Write-Output ""; 
            }
        };
        . Search-DetectableEvents $args;
    };
    if(! $ruleStack[$ruleName]) {
        $ruleStack.Add($ruleName, $detectRule);
    } else {
       Write-Host "Rule Import Error"  -Foreground Yellow;
    }
}
